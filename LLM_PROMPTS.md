# SiYuan 数据库显示插件 - 大模型提示词库

## 📋 目录
1. [项目理解提示词](#项目理解提示词)
2. [功能实现提示词](#功能实现提示词)
3. [代码优化提示词](#代码优化提示词)
4. [Bug 修复提示词](#bug-修复提示词)
5. [功能扩展提示词](#功能扩展提示词)

---

## 项目理解提示词

### 1. 项目架构总体理解
```
我需要理解一个思源笔记插件项目的整体架构。这是一个数据库属性显示插件，它需要：
1. 监听文档/块的加载事件
2. 查询数据库属性字段信息
3. 在文档标题或块属性面板下方插入自定义 DOM 元素显示字段值
4. 为显示的字段提供编辑功能

请根据项目源码 (src/index.ts, src/db_pro.ts, src/extract-meta.ts) 为我讲解：
- 主要使用的事件系统有哪些？
- DOM 查询和插入的目标元素类型有哪些？
- 数据流从 API 到 DOM 显示的全流程是什么？
- 哪些机制保证了数据的实时同步？
```

### 2. DOM 监听机制理解
```
这个插件实现了多层次的 DOM 监听和自动刷新。请解释：

1. 事件总线监听：
   - switch-protyle 事件何时触发？
   - loaded-protyle-dynamic vs loaded-protyle-static 的区别？
   
2. WebSocket 实时监听：
   - 如何监听 updateAttrViewCell 事件？
   - 这个事件对应用户什么操作？
   
3. MutationObserver 监听：
   - 监听的目的是什么？
   - 防抖机制如何实现的？
   
4. 自动刷新机制：
   - 智能休眠如何工作？
   - 外部触发标记的意义？

请结合代码片段进行详细说明。
```

### 3. DOM 插入流程理解
```
这个插件需要在两个不同的位置插入数据：
1. 文档级别：.protyle-title 下的 .protyle-attr
2. 块级别：[custom-avs] 下的 .protyle-attr

请详细说明：
- 如何区分这两种场景？
- 目标容器的定位逻辑？
- 为什么要过滤 TalDraw 等特殊容器？
- 清空旧显示的必要性？
- 元数据如何存储在 DOM dataset 中供后续编辑使用？
- 为什么使用 insertBefore 而不是 appendChild？
```

### 4. 数据流转理解
```
从数据库到显示的完整数据流程：

API 层：getAttributeViewKeys() 返回原始数据结构
  ↓
提取层：extractContentsWithMeta() 处理和转换
  ↓
DOM 层：创建 span 元素并存储 dataset
  ↓
交互层：用户点击后 enableInlineEdit() 弹出编辑界面
  ↓
保存层：setBlockAttribute() 调用 API 保存

请说明每一层的核心职责和数据结构变化。
```

---

## 功能实现提示词

### 1. 添加新的字段类型显示
```
我想在这个插件中添加对 "relation" 字段类型的显示支持。

当前支持的类型有：mSelect, number, date, text, mAsset, checkbox, phone, url, email, created, updated

请帮我：
1. 在 src/handleKey.ts 中添加 relation 类型的文本转换逻辑
2. 确保 extractContentsWithMeta() 能正确识别 relation 类型的值
3. 在编辑流程中为 relation 类型添加特殊处理
4. 在配置中允许用户选择是否显示 relation 字段

需要修改哪些文件？关键代码点是什么？
```

### 2. 实现新的编辑界面类型
```
我想为 "template" 字段类型添加一个特殊的编辑界面，它应该：
1. 显示模板渲染结果的预览
2. 提供一个按钮来刷新预览
3. 允许用户输入模板参数

基于当前的 enableInlineEdit() 架构：
- 应该在哪里添加 handleTemplateEdit() 函数？
- 如何集成 Sprig 模板渲染 API？
- 编辑界面的 DOM 结构应该如何设计？
- 保存逻辑与其他类型有什么不同？
```

### 3. 添加字段分组显示
```
用户要求在插件中按字段类型分组显示数据。例如：

[日期字段]
  2024-01-15
  2024-01-20

[多选字段]
  tag1, tag2
  tag3, tag4

请设计一个分组显示的实现方案：
1. 在哪一层进行分组（提取层还是 DOM 层）？
2. 如何修改 DOM 结构来支持分组？
3. 如何处理空分组的显示？
4. 这个改动对现有的编辑流程有什么影响？
```

### 4. 实现自定义渲染模板
```
我想让用户能够自定义每个字段类型的显示模板。例如：

数字字段可以显示为：100 | 100% | $100 等

配置格式可能是：
{
  "number": "{value} {unit}",
  "date": "{date|format:YYYY-MM-DD}",
  "text": "{value|truncate:20}"
}

请设计实现方案：
1. 设置界面如何让用户输入模板？
2. 在哪里编译和缓存模板？
3. 在 DOM 渲染时如何应用模板？
4. 如何在模板中支持过滤器（format, truncate 等）？
5. 如何处理模板错误和降级显示？
```

---

## 代码优化提示词

### 1. 性能优化建议
```
分析这个插件的性能瓶颈：

当前实现中：
- 每次触发都要查询所有 .protyle-title 和 [custom-avs] 元素
- 每个字段都要调用 getAttributeViewKeys API
- MutationObserver 观察整个 document.body

请建议：
1. 如何使用 CSS 选择器优化元素查询性能？
2. 如何进一步优化缓存策略（当前是 1 分钟）？
3. MutationObserver 的观察范围是否可以缩小？
4. 是否可以使用事件委托来优化编辑事件监听？
5. 对于大量显示字段的文档，如何避免 DOM 操作过多？

请提供具体的代码改进建议。
```

### 2. 代码重构建议
```
这个项目的 index.ts 文件已经超过 500 行，包含了太多责任。请建议如何重构：

当前职责混合：
- 事件管理
- DOM 查询和操作
- 数据提取
- 编辑事件处理
- 设置管理
- 自动刷新逻辑

请建议：
1. 如何按职责分离代码？
2. 建议的类/模块结构是什么？
3. 如何定义清晰的模块接口？
4. 重构过程中如何保证不引入 bug？
5. 是否应该引入状态管理库？
```

### 3. 代码可读性改进
```
请建议如何改进代码的可读性和可维护性：

1. 长函数 showdata_doc() 和 showdata_block() 有大量重复代码
   - 如何提取公共逻辑？
   - 是否应该创建一个通用的数据显示模块？

2. 嵌套的事件监听和条件判断很复杂
   - 如何使用更清晰的流程控制？
   - 是否应该使用状态机来管理不同的加载状态？

3. 元数据存储在 dataset 中容易出错
   - 如何创建类型安全的 dataset 访问工具？
   - 是否应该使用 WeakMap 来存储关联数据？

4. 魔法数字和字符串分散在代码中
   - 如何集中管理这些常量？
   - 是否应该创建配置文件？
```

### 4. 测试覆盖建议
```
这个插件缺少单元测试。请建议：

1. 最关键的需要测试的模块是什么？
2. 如何测试 DOM 操作？
3. 如何 mock 思源的 API 和事件系统？
4. 如何测试异步的刷新流程？
5. 应该添加什么集成测试来保证多个事件源的协调？
6. 推荐的测试框架和工具是什么？

请提供一个测试计划。
```

---

## Bug 修复提示词

### 1. 修复 DOM 闪烁问题
```
用户反馈：当快速切换文档时，数据显示会出现闪烁（显示→隐藏→显示）。

分析：
- 当前使用 setTimeout(..., 10) 延迟加载
- 多个事件可能在短时间内都触发
- clearAutoTimer 可能没有正确清理

请帮我：
1. 定位这个问题的根本原因
2. 如何实现防抖或去重来避免重复渲染？
3. 是否应该在 DOM 渲染前检查当前焦点？
4. 如何测试这个修复？
5. 是否需要添加加载状态指示？
```

### 2. 修复编辑后数据不同步
```
用户反馈：有时编辑了数据后，显示没有正确更新。

可能的原因：
- refreshCallback() 没有被正确调用
- WebSocket 消息处理有延迟
- 缓存没有被正确清理
- itemID 与 blockID 的映射错误

请帮我调查和修复：
1. 追踪 setBlockAttribute 的完整调用链
2. 确保 clearKeyCache 在正确的时机被调用
3. 检查 blockID 到 itemID 的映射是否总是正确的
4. 添加日志来追踪数据同步过程
5. 如何写一个测试来重现这个 bug？
```

### 3. 修复特殊字符显示错误
```
用户反馈：包含特殊字符的字段值（如 HTML 标签、换行符）显示不正确。

当前代码直接使用 textContent，但某些情况下需要转义。

请帮我：
1. 识别哪些字符会导致显示错误
2. 应该在哪里进行转义（提取层还是 DOM 层）？
3. 对于包含 HTML 的字段，是否需要特殊处理？
4. 如何处理超长字符串的截断？
5. 如何在 aria-label 中正确处理特殊字符？
```

### 4. 修复内存泄漏
```
用户反馈：插件运行一段时间后，浏览器内存占用持续增长。

可能的原因：
- 事件监听器没有被正确注销
- MutationObserver 没有被 disconnect
- 缓存数据没有过期删除
- 弹窗元素没有被完全移除

请帮我：
1. 使用 Chrome DevTools 识别内存泄漏位置
2. 检查所有事件监听器的生命周期管理
3. 确保 MutationObserver 和 timer 都被正确清理
4. 实现缓存大小限制和 LRU 策略
5. 检查弹窗关闭时是否完全移除了 DOM
```

---

## 功能扩展提示词

### 1. 实现关联字段的级联显示
```
现在用户想看到关联字段指向的其他数据库记录的某些字段。例如：

任务记录有 "负责人" 关联到人员数据库
现在想显示 "负责人.部门" 这样的级联字段

请设计实现方案：
1. 配置格式应该是什么？
2. 如何递归查询关联数据而不导致循环依赖？
3. 如何处理权限问题（用户可能看不到关联的记录）？
4. 如何缓存关联数据以避免过多 API 调用？
5. 编辑界面如何处理级联关联的修改？
```

### 2. 实现字段值的数据验证和警告
```
用户想要对某些字段进行验证，例如：

- 邮箱字段必须是有效的邮箱格式
- 数字字段必须在某个范围内
- 必填字段不能为空

如果验证失败，显示警告图标。

请设计实现方案：
1. 验证规则的配置格式？
2. 在哪一层进行验证（提取层、显示层、还是两者）？
3. 验证结果如何反映在 DOM 中？
4. 点击警告图标应该显示什么提示？
5. 如何与现有的编辑流程集成？
```

### 3. 实现数据的条件显示和过滤
```
用户想要根据条件来决定是否显示某个字段。例如：

- 只有当 "状态" = "完成" 时，才显示 "完成时间"
- 只有当 "类型" 包含 "bug" 时，才显示 "严重级别"

请设计实现方案：
1. 条件语法应该是什么？（SQL, JSONPath, 还是自定义？）
2. 条件在提取层进行还是显示层进行？
3. 如何高效地评估复杂条件？
4. 条件变化时如何自动刷新显示？
5. 编辑流程中如何处理条件的动态变化？
```

### 4. 实现字段值的聚合和统计
```
用户想在属性面板中显示某些统计信息，例如：

- 数字字段的总和、平均值
- 多选字段中各选项的出现次数
- 日期字段的时间跨度

这些统计针对的是同一个块关联的所有数据库记录。

请设计实现方案：
1. 统计配置的格式？
2. 统计信息在哪一层计算？
3. 如何在 DOM 中展现统计信息？
4. 统计数据如何缓存和更新？
5. 性能是否会受到影响？
```

### 5. 实现批量编辑功能
```
用户想要一次性编辑多个相关记录的同一个字段。例如：

点击一个链接，弹出所有关联记录列表，让用户批量修改某个字段的值。

请设计实现方案：
1. 批量编辑的 UI 应该是什么样的？
2. 如何获取所有需要修改的记录？
3. 修改操作如何批量执行？
4. 如何处理修改失败的单条记录？
5. 修改完成后如何刷新相关显示？
6. 是否需要事务处理来保证一致性？
```

---

## 高级主题提示词

### 1. 性能优化：虚拟滚动
```
某些用户的文档中可能有数百个块，每个块都有多个数据库字段要显示。
这导致 DOM 节点数量过多，页面滚动卡顿。

请设计一个虚拟滚动的实现方案：
1. 如何检测当前可视区域的块元素？
2. 只为可视块渲染字段显示，滚动时更新？
3. 如何与现有的事件系统集成？
4. 是否需要使用 IntersectionObserver？
5. 如何处理滚动期间的数据更新？
```

### 2. 功能扩展：导出和备份
```
用户想要导出所有显示的字段数据到 CSV 或 JSON 文件。

请设计实现方案：
1. 导出菜单应该添加在哪里？
2. 如何组织导出的数据结构？
3. 导出时是否应该包含原始值还是显示值？
4. 如何处理大型数据集的导出？
5. 是否需要实现增量备份？
```

### 3. 集成：与其他插件的交互
```
用户想要这个插件与其他思源插件协作，例如：

- 与数据库视图插件共享数据
- 与任务管理插件集成
- 与时间追踪插件关联

请建议：
1. 如何定义清晰的 API 接口供其他插件使用？
2. 是否应该使用事件系统来通信？
3. 如何避免循环依赖？
4. 版本兼容性如何处理？
5. 如何文档化这些 API？
```

---

## 特定场景提示词

### 场景 1：复杂关系型数据库
```
用户有一个复杂的数据库结构：
- 项目表 ← 关联 → 任务表 ← 关联 → 子任务表
- 每个表都有多个字段

用户希望在项目块中同时看到：
1. 项目的直接字段
2. 所有关联任务的字段统计
3. 所有子任务的某些关键信息

这对当前的插件架构是什么样的挑战？如何解决？
```

### 场景 2：实时协作编辑
```
多个用户在同时编辑同一个文档和数据库。

当前的实现中：
- 如何确保用户看到最新的数据？
- 如何处理冲突编辑？
- 如何减少不必要的 API 调用？

请建议改进方案。
```

### 场景 3：大规模部署
```
某个组织想要在数千个文档中部署这个插件。

性能和可扩展性的考虑：
1. 后端 API 的负载如何管理？
2. 缓存策略如何优化？
3. 客户端的内存占用如何控制？
4. 如何监控插件的性能指标？
5. 如何进行灰度发布和回滚？
```

---

## 使用建议

### 如何使用这些提示词

1. **逐层深入**：从"项目理解"开始，逐步深入到具体功能实现

2. **结合源码**：在提问时附带相关源码片段，让大模型有更好的上下文

3. **具体化需求**：修改提示词中的例子以符合实际需求

4. **验证理解**：在大模型给出方案后，询问"这个实现的关键风险是什么？"

5. **迭代改进**：根据大模型的回答，继续提出追问和细化需求

### 示例对话流程

```
Q: [使用"项目架构总体理解"提示词]
A: [大模型给出架构说明]

Q: [追问] 在这个架构中，如何处理 X 场景？
A: [大模型给出具体建议]

Q: [使用相关代码片段] 请帮我实现这个改进...
A: [大模型提供代码示例]

Q: [审视结果] 这个方案的性能如何？有什么潜在问题？
A: [大模型分析风险和优化建议]
```

### 上下文保持

为了让大模型保持对项目的理解，在每次对话的开始可以加入：

```
这是一个思源笔记的数据库显示插件。主要功能是：
- 监听文档加载事件（switch-protyle, loaded-protyle-*)
- 在属性面板中显示关联数据库的字段值
- 支持点击编辑这些字段值

核心文件：
- src/index.ts (500+ 行，主要插件逻辑)
- src/db_pro.ts (AVManager 类，数据库 API 封装)
- src/extract-meta.ts (数据提取和转换)
- src/inline-edit.ts (编辑界面)

[在这个背景下] [使用具体提示词]
```
